{% extends "base.html" %}
{% block content %}
<h1 class="mb-3">Pay for Order #{{ order.id }}</h1>
<p class="text-muted">Total due: â‚¬{{ order.total }}</p>

<!-- 1) Load Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<!-- 2) Payment Element container -->
<div class="card">
  <div class="card-body">
    <form id="payment-form">
      <div id="payment-element"><!-- Stripe injects form fields here --></div>
      <button id="submit" class="btn btn-primary mt-3">Pay</button>
      <div id="error-message" class="text-danger mt-2" role="alert"></div>
    </form>
  </div>
</div>

<script>
  // 3) Init Stripe
  const stripe = Stripe("{{ stripe_publishable_key }}");
  const options = {
    clientSecret: "{{ client_secret }}",
  };
  const elements = stripe.elements(options);
  const paymentElement = elements.create("payment");
  paymentElement.mount("#payment-element");

  // 4) Handle submit
  const form = document.getElementById("payment-form");
  const submitBtn = document.getElementById("submit");
  const errorDiv = document.getElementById("error-message");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;

    const { error } = await stripe.confirmPayment({
      elements,
      confirmParams: {
        // After successful payment, return to thank-you
        return_url: window.location.origin + "{% url 'orders:thank_you' order_id=order.id %}",
      },
    });

    if (error) {
      errorDiv.textContent = error.message || "Payment failed. Please try again.";
      submitBtn.disabled = false;
    }
  });
</script>
{% endblock %}
